<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Strikers Bowling - Admin Panel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .back-button {
      display: inline-block;
      padding: 10px 20px;
      background: transparent;
      border: 2px solid #4E98D5;
      color: #4E98D5;
      text-decoration: none;
      border-radius: 25px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background: #4E98D5;
      color: #ffffff;
    }

    h1 {
      color: #96333C;
      font-size: 3rem;
      text-align: center;
      margin-bottom: 20px;
    }

    .subtitle {
      text-align: center;
      color: #999;
      margin-bottom: 40px;
      font-size: 1.1rem;
    }

    .login-box {
      background: #2a2a2a;
      border-radius: 20px;
      padding: 40px;
      max-width: 400px;
      margin: 100px auto;
      border: 2px solid #96333C;
    }

    .login-box h2 {
      color: #96333C;
      margin-bottom: 30px;
      text-align: center;
    }

    input[type="password"],
    input[type="file"] {
      width: 100%;
      padding: 15px;
      margin-bottom: 20px;
      background: #1a1a1a;
      border: 2px solid #444;
      border-radius: 10px;
      color: #ffffff;
      font-size: 1rem;
    }

    button {
      width: 100%;
      padding: 15px;
      background: #96333C;
      border: none;
      border-radius: 50px;
      color: #ffffff;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      background: #7a2830;
      transform: translateY(-2px);
    }

    .league-selector {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 40px;
    }

    .league-btn {
      padding: 12px 25px;
      background: transparent;
      border: 2px solid #4E98D5;
      color: #4E98D5;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: auto;
    }

    .league-btn:hover {
      background: #4E98D5;
      color: #ffffff;
    }

    .league-btn.active {
      background: #96333C;
      border-color: #96333C;
      color: #ffffff;
    }

    .upload-box {
      background: #2a2a2a;
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 30px;
      border: 2px solid #444;
    }

    .upload-box h3 {
      color: #96333C;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .upload-label {
      display: block;
      width: 100%;
      padding: 60px 20px;
      background: #1a1a1a;
      border: 3px dashed #96333C;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .upload-label:hover {
      border-color: #4E98D5;
      background: #252525;
    }

    .upload-label .icon {
      font-size: 3rem;
      margin-bottom: 10px;
    }

    .status {
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
      font-weight: 600;
    }

    .status.success {
      background: rgba(76, 175, 80, 0.2);
      border: 2px solid #4CAF50;
      color: #4CAF50;
    }

    .status.error {
      background: rgba(244, 67, 54, 0.2);
      border: 2px solid #f44336;
      color: #f44336;
    }

    .current-file {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .current-file h4 {
      color: #4E98D5;
      margin-bottom: 10px;
    }

    .current-file p {
      color: #999;
      margin-bottom: 15px;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .secondary-btn {
      background: transparent;
      border: 2px solid #f44336;
      color: #f44336;
    }

    .secondary-btn:hover {
      background: #f44336;
      color: #ffffff;
    }

    .preview-btn {
      background: transparent;
      border: 2px solid #4E98D5;
      color: #4E98D5;
    }

    .preview-btn:hover {
      background: #4E98D5;
      color: #ffffff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="app"></div>
  </div>

  <script>
    const ADMIN_PASSWORD = 'strikers2025';
    
    // Default leagues for initial setup
    const DEFAULT_LEAGUES = [
      {
        name: 'Monday Night Open',
        day: 'Monday',
        time: '7:00 PM',
        format: 'Open',
        totalWeeks: 30,
        description: 'Open to all bowlers',
        active: true
      },
      {
        name: 'Tuesday Night Ladies',
        day: 'Tuesday',
        time: '6:30 PM',
        format: 'Ladies',
        totalWeeks: 30,
        description: 'Ladies league',
        active: true
      },
      {
        name: 'Wednesday Night Mixed',
        day: 'Wednesday',
        time: '7:00 PM',
        format: 'Mixed',
        totalWeeks: 30,
        description: 'Mixed doubles league',
        active: true
      },
      {
        name: 'Church League',
        day: 'Thursday',
        time: '6:00 PM',
        format: 'Mixed',
        totalWeeks: 24,
        description: 'Church league - Family friendly',
        active: true
      },
      {
        name: 'Youth',
        day: 'Saturday',
        time: '10:00 AM',
        format: 'Youth',
        totalWeeks: 20,
        description: 'Youth bowling program',
        active: true
      }
    ];

    let isAuthenticated = sessionStorage.getItem('adminAuth') === 'true';
    let currentView = 'standings'; // 'standings' or 'leagues'
    let selectedLeague = null;
    let allLeagues = [];
    let weekNumber = '';
    let db = null;

    // Initialize IndexedDB
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('StrikersStandingsDB', 2);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // Create object store for PDFs
          if (!db.objectStoreNames.contains('pdfs')) {
            const pdfStore = db.createObjectStore('pdfs', { keyPath: 'id' });
            pdfStore.createIndex('league', 'league', { unique: false });
          }
          
          // Create object store for weeks metadata
          if (!db.objectStoreNames.contains('weeks')) {
            db.createObjectStore('weeks', { keyPath: 'league' });
          }
          
          // Create object store for league configurations
          if (!db.objectStoreNames.contains('leagues')) {
            db.createObjectStore('leagues', { keyPath: 'name' });
          }
        };
      });
    }

    // Get all weeks for a league
    async function getWeeksForLeague(league) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['weeks'], 'readonly');
        const store = transaction.objectStore('weeks');
        const request = store.get(league);
        
        request.onsuccess = () => {
          resolve(request.result?.weeks || []);
        };
        request.onerror = () => resolve([]);
      });
    }

    // Save weeks list for a league
    async function saveWeeksForLeague(league, weeks) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['weeks'], 'readwrite');
        const store = transaction.objectStore('weeks');
        const request = store.put({ league, weeks });
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // Save PDF to IndexedDB
    async function savePDF(league, week, fileName, pdfData) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['pdfs'], 'readwrite');
        const store = transaction.objectStore('pdfs');
        const request = store.put({
          id: `${league}_${week}`,
          league,
          week,
          fileName,
          pdfData,
          uploadDate: new Date().toISOString()
        });
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // Get PDF from IndexedDB
    async function getPDF(league, week) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['pdfs'], 'readonly');
        const store = transaction.objectStore('pdfs');
        const request = store.get(`${league}_${week}`);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => resolve(null);
      });
    }

    // Remove PDF from IndexedDB
    async function removePDF(league, week) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['pdfs'], 'readwrite');
        const store = transaction.objectStore('pdfs');
        const request = store.delete(`${league}_${week}`);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // Get all leagues
    async function getAllLeagues() {
      return new Promise((resolve) => {
        const transaction = db.transaction(['leagues'], 'readonly');
        const store = transaction.objectStore('leagues');
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => resolve([]);
      });
    }

    // Save league configuration
    async function saveLeague(leagueConfig) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['leagues'], 'readwrite');
        const store = transaction.objectStore('leagues');
        const request = store.put(leagueConfig);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // Delete league and all associated data
    async function deleteLeague(leagueName) {
      return new Promise(async (resolve, reject) => {
        try {
          // Delete league config
          const leagueTransaction = db.transaction(['leagues'], 'readwrite');
          const leagueStore = leagueTransaction.objectStore('leagues');
          await new Promise((res) => {
            const req = leagueStore.delete(leagueName);
            req.onsuccess = () => res();
            req.onerror = () => res();
          });
          
          // Delete weeks metadata
          const weeksTransaction = db.transaction(['weeks'], 'readwrite');
          const weeksStore = weeksTransaction.objectStore('weeks');
          await new Promise((res) => {
            const req = weeksStore.delete(leagueName);
            req.onsuccess = () => res();
            req.onerror = () => res();
          });
          
          // Delete all PDFs for this league
          const pdfsTransaction = db.transaction(['pdfs'], 'readwrite');
          const pdfsStore = pdfsTransaction.objectStore('pdfs');
          const index = pdfsStore.index('league');
          const pdfsRequest = index.openCursor(IDBKeyRange.only(leagueName));
          
          pdfsRequest.onsuccess = (event) => {
            const cursor = event.target.result;
            if (cursor) {
              cursor.delete();
              cursor.continue();
            } else {
              resolve();
            }
          };
          pdfsRequest.onerror = () => resolve();
        } catch (error) {
          reject(error);
        }
      });
    }

    // Initialize default leagues if none exist
    async function initializeDefaultLeagues() {
      const leagues = await getAllLeagues();
      if (leagues.length === 0) {
        console.log('Initializing default leagues...');
        for (const league of DEFAULT_LEAGUES) {
          await saveLeague(league);
        }
      }
    }

    // Get storage usage estimate
    async function getStorageUsage() {
      if (navigator.storage && navigator.storage.estimate) {
        const estimate = await navigator.storage.estimate();
        const usedMB = (estimate.usage / (1024 * 1024)).toFixed(2);
        const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(0);
        return { used: usedMB, quota: quotaMB };
      }
      return { used: 'N/A', quota: 'N/A' };
    }

    // Migrate from localStorage to IndexedDB
    async function migrateFromLocalStorage() {
      if (localStorage.getItem('migrated_to_indexeddb')) return;
      
      console.log('Migrating data from localStorage to IndexedDB...');
      
      // Migrate old hardcoded leagues
      const oldLeagues = [
        'Monday Night Open',
        'Tuesday Night Ladies',
        'Wednesday Night Mixed',
        'Church League',
        'Youth'
      ];
      
      for (const league of oldLeagues) {
        // Get old weeks data
        const weeksData = localStorage.getItem(`weeks_${league}`);
        if (weeksData) {
          try {
            const weeks = JSON.parse(weeksData);
            await saveWeeksForLeague(league, weeks);
            
            // Migrate each week's PDF
            for (const week of weeks) {
              const pdfData = localStorage.getItem(`pdf_${league}_${week.week}`);
              if (pdfData) {
                await savePDF(league, week.week, week.fileName, pdfData);
                localStorage.removeItem(`pdf_${league}_${week.week}`);
              }
            }
            
            localStorage.removeItem(`weeks_${league}`);
          } catch (e) {
            console.error('Migration error:', e);
          }
        }
        
        // Clean up old single-PDF format
        localStorage.removeItem(`pdf_${league}`);
        localStorage.removeItem(`pdf_name_${league}`);
      }
      
      localStorage.setItem('migrated_to_indexeddb', 'true');
      console.log('Migration complete!');
    }

    async function render() {
      const app = document.getElementById('app');
      
      if (!isAuthenticated) {
        app.innerHTML = `
          <div class="login-box">
            <h2>Admin Login</h2>
            <input type="password" id="password" placeholder="Enter admin password" />
            <button onclick="login()">Login</button>
          </div>
        `;
        document.getElementById('password').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') login();
        });
      } else {
        // Load leagues dynamically
        allLeagues = await getAllLeagues();
        const activeLeagues = allLeagues.filter(l => l.active);
        
        // Auto-select first league if none selected
        if (!selectedLeague && activeLeagues.length > 0) {
          selectedLeague = activeLeagues[0].name;
        }
        
        const weeks = selectedLeague ? await getWeeksForLeague(selectedLeague) : [];
        const storage = await getStorageUsage();
        const usedPercent = storage.quota !== 'N/A' ? (parseFloat(storage.used) / parseFloat(storage.quota) * 100).toFixed(1) : 0;
        
        app.innerHTML = `
          <a href="/" class="back-button">← Back to Site</a>
          <a href="/admin-leagues.html" class="back-button" style="background: #96333C; border-color: #96333C; color: white;">⚙️ Manage Leagues</a>
          <h1>Update League Standings</h1>
          <p class="subtitle">Upload PDF standings for your leagues - Unlimited weeks supported</p>
          
          <div style="text-align: center; margin-bottom: 20px;">
            <span style="color: #888; font-size: 0.9rem;">
              Storage Used: <strong style="color: ${usedPercent > 80 ? '#FF6B6B' : '#4E98D5'}">${storage.used} MB</strong> / ${storage.quota} MB
              ${storage.quota !== 'N/A' ? `<span style="color: #666;">(${usedPercent}%)</span>` : ''}
            </span>
          </div>
          
          ${activeLeagues.length === 0 ? `
            <div style="text-align: center; padding: 60px 20px; color: #888;">
              <div style="font-size: 4rem; margin-bottom: 20px;">🎳</div>
              <h2>No Active Leagues</h2>
              <p style="margin-bottom: 20px;">Add some leagues to get started</p>
              <a href="/admin-leagues.html" style="display: inline-block; padding: 15px 30px; background: #96333C; color: white; text-decoration: none; border-radius: 25px;">
                Manage Leagues
              </a>
            </div>
          ` : `
          <div class="league-selector">
            ${activeLeagues.map(league => `
              <button class="league-btn ${league.name === selectedLeague ? 'active' : ''}" 
                      onclick="selectLeague('${league.name}')">
                ${league.name}
              </button>
            `).join('')}
          </div>

          <div class="upload-box">
            <h3>📄 Upload New Standings for ${selectedLeague}</h3>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; color: #4E98D5; margin-bottom: 10px; font-weight: 600;">
                Week Number or Label:
              </label>
              <input 
                type="text" 
                id="weekInput" 
                placeholder="e.g., Week 1, Week 2, Finals, etc." 
                style="width: 100%; max-width: 400px; padding: 12px; background: #1a1a1a; border: 2px solid #444; border-radius: 10px; color: #fff; font-size: 1rem;"
              />
            </div>
            
            <label for="pdfFile" class="upload-label">
              <div class="icon">📤</div>
              <div style="font-size: 1.2rem; color: #fff; margin-bottom: 10px;">
                Click to upload PDF
              </div>
              <div style="color: #999; font-size: 0.9rem;">
                or drag and drop
              </div>
            </label>
            <input type="file" id="pdfFile" accept=".pdf" style="display: none;" onchange="handlePDFUpload(event)" />
            
            <div id="status"></div>
          </div>

          ${weeks.length > 0 ? `
            <div class="upload-box">
              <h3>📋 Uploaded Standings for ${selectedLeague}</h3>
              <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                ${weeks.map(week => `
                  <div class="current-file">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                      <div>
                        <h4>${week.week}</h4>
                        <p>📄 ${week.fileName}</p>
                      </div>
                      <div class="button-group" style="margin-top: 0;">
                        <button class="preview-btn" onclick="previewWeekPDF('${week.week}')">👁️ Preview</button>
                        <button class="secondary-btn" onclick="removeWeekPDF('${week.week}')">🗑️ Remove</button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <div style="text-align: center; margin-top: 30px; padding: 20px; border-top: 1px solid #333;">
            <button 
              onclick="clearAllStorage()" 
              style="background: #FF6B6B; color: white; border: none; padding: 12px 30px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1rem;"
              onmouseover="this.style.background='#FF5252'" 
              onmouseout="this.style.background='#FF6B6B'"
            >
              🗑️ Clear All League Data
            </button>
            <p style="color: #999; font-size: 0.85rem; margin-top: 10px;">
              This will remove all uploaded PDFs for all leagues
            </p>
          </div>
        `}
        `;

        // Add drag and drop functionality only if there are active leagues
        if (activeLeagues.length > 0) {
          const label = document.querySelector('.upload-label');
        label.addEventListener('dragover', (e) => {
          e.preventDefault();
          label.style.borderColor = '#4E98D5';
          label.style.background = '#252525';
        });
        label.addEventListener('dragleave', () => {
          label.style.borderColor = '#96333C';
          label.style.background = '#1a1a1a';
        });
        label.addEventListener('drop', (e) => {
          e.preventDefault();
          label.style.borderColor = '#96333C';
          label.style.background = '#1a1a1a';
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            document.getElementById('pdfFile').files = files;
            handlePDFUpload({ target: { files: files } });
          }
        });
        }
      }
    }

    function login() {
      const password = document.getElementById('password').value;
      if (password === ADMIN_PASSWORD) {
        isAuthenticated = true;
        sessionStorage.setItem('adminAuth', 'true');
        render();
      } else {
        alert('Incorrect password!');
      }
    }

    function selectLeague(league) {
      selectedLeague = league;
      render();
    }

    async function handlePDFUpload(event) {
      const file = event.target.files[0];
      if (!file || file.type !== 'application/pdf') {
        showStatus('Please upload a valid PDF file', 'error');
        return;
      }

      // Get week number/label
      const weekInput = document.getElementById('weekInput');
      const week = weekInput?.value.trim();
      
      if (!week) {
        showStatus('❌ Please enter a week number or label!', 'error');
        return;
      }

      // Check file size (recommended max 10MB per PDF for optimal performance)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        showStatus('❌ File too large! Please upload a PDF smaller than 10MB for best performance.', 'error');
        event.target.value = '';
        return;
      }

      showStatus('Uploading PDF...', '');

      try {
        // Convert PDF to base64
        const reader = new FileReader();
        
        reader.onerror = function() {
          showStatus('❌ Error reading file. Please try again.', 'error');
        };
        
        reader.onload = async function(e) {
          try {
            const base64 = e.target.result;
            
            // Verify it's a valid data URL
            if (!base64.startsWith('data:application/pdf')) {
              showStatus('❌ Invalid PDF format. Please try another file.', 'error');
              return;
            }
            
            // Try to store in IndexedDB
            try {
              // Save PDF data
              await savePDF(selectedLeague, week, file.name, base64);
              
              // Update weeks list
              const weeks = await getWeeksForLeague(selectedLeague);
              const existingWeek = weeks.find(w => w.week === week);
              
              if (existingWeek) {
                existingWeek.fileName = file.name;
                existingWeek.uploadDate = new Date().toISOString();
              } else {
                weeks.push({
                  week: week,
                  fileName: file.name,
                  uploadDate: new Date().toISOString()
                });
              }
              
              // Sort weeks naturally (Week 1, Week 2, etc.)
              weeks.sort((a, b) => {
                const aNum = parseInt(a.week.match(/\d+/)?.[0] || '999');
                const bNum = parseInt(b.week.match(/\d+/)?.[0] || '999');
                return aNum - bNum;
              });
              
              await saveWeeksForLeague(selectedLeague, weeks);
              
              showStatus(`✅ Successfully uploaded ${file.name} for ${week}!`, 'success');
              
              // Re-render to show the uploaded file
              setTimeout(() => render(), 1500);
            } catch (storageError) {
              console.error('Storage error:', storageError);
              showStatus('❌ Error saving PDF. Please try again.', 'error');
            }
          } catch (error) {
            console.error('Processing error:', error);
            showStatus('❌ Error processing PDF. Please try again.', 'error');
          }
        };
        
        reader.readAsDataURL(file);
      } catch (error) {
        console.error('PDF upload error:', error);
        showStatus('❌ Error uploading PDF. Please try again.', 'error');
      }

      event.target.value = '';
    }

    async function previewWeekPDF(week) {
      const pdfRecord = await getPDF(selectedLeague, week);
      if (!pdfRecord || !pdfRecord.pdfData) {
        showStatus('No PDF found for this week', 'error');
        return;
      }
      
      const pdfData = pdfRecord.pdfData;
      
      // Check if it's a valid data URL
      if (!pdfData.startsWith('data:application/pdf')) {
        showStatus('Invalid PDF data. Please re-upload the file.', 'error');
        return;
      }
      
      try {
        // Convert base64 to Blob URL for better browser compatibility
        const base64String = pdfData.split(',')[1];
        const binaryString = window.atob(base64String);
        const bytes = new Uint8Array(binaryString.length);
        
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        
        const blob = new Blob([bytes], { type: 'application/pdf' });
        const blobUrl = URL.createObjectURL(blob);
        
        // Open PDF in new tab
        const win = window.open(blobUrl, '_blank');
        
        if (!win) {
          showStatus('Please allow pop-ups to preview PDFs', 'error');
          URL.revokeObjectURL(blobUrl);
        } else {
          // Clean up the blob URL after a delay
          setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
        }
      } catch (error) {
        console.error('PDF preview error:', error);
        showStatus('Error previewing PDF. Please try re-uploading.', 'error');
      }
    }

    async function removeWeekPDF(week) {
      if (confirm(`Are you sure you want to remove the standings PDF for ${selectedLeague} - ${week}?`)) {
        try {
          // Remove PDF data
          await removePDF(selectedLeague, week);
          
          // Update weeks list
          const weeks = await getWeeksForLeague(selectedLeague);
          const updatedWeeks = weeks.filter(w => w.week !== week);
          await saveWeeksForLeague(selectedLeague, updatedWeeks);
          
          showStatus('PDF removed successfully!', 'success');
          setTimeout(() => render(), 1000);
        } catch (error) {
          console.error('Error removing PDF:', error);
          showStatus('❌ Error removing PDF. Please try again.', 'error');
        }
      }
    }

    async function clearAllStorage() {
      if (confirm('⚠️ WARNING: This will delete ALL uploaded PDFs for ALL leagues. This cannot be undone. Are you sure?')) {
        if (confirm('Are you ABSOLUTELY sure? This will clear all league standings data.')) {
          try {
            // Get all leagues (including inactive ones)
            const leagues = await getAllLeagues();
            
            // Remove all PDF data and weeks lists from IndexedDB
            for (const league of leagues) {
              const weeks = await getWeeksForLeague(league.name);
              for (const week of weeks) {
                await removePDF(league.name, week.week);
              }
              
              // Clear weeks metadata
              const transaction = db.transaction(['weeks'], 'readwrite');
              const store = transaction.objectStore('weeks');
              await new Promise((resolve) => {
                const request = store.delete(league.name);
                request.onsuccess = () => resolve();
                request.onerror = () => resolve();
              });
            }
            
            // Also clean up any old localStorage data
            leagues.forEach(league => {
              localStorage.removeItem(`pdf_${league.name}`);
              localStorage.removeItem(`pdf_name_${league.name}`);
              localStorage.removeItem(`weeks_${league.name}`);
            });
            
            showStatus('✅ All league data cleared successfully!', 'success');
            setTimeout(() => render(), 1500);
          } catch (error) {
            console.error('Error clearing storage:', error);
            showStatus('❌ Error clearing data. Please try again.', 'error');
          }
        }
      }
    }

    function showStatus(message, type) {
      const statusEl = document.getElementById('status');
      if (statusEl) {
        statusEl.className = `status ${type}`;
        statusEl.textContent = message;
      }
    }

    // Initialize database and render
    initDB().then(async () => {
      await migrateFromLocalStorage();
      await initializeDefaultLeagues();
      render();
    }).catch(error => {
      console.error('Database initialization error:', error);
      document.getElementById('app').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #FF6B6B;">
          <h2>⚠️ Database Error</h2>
          <p>Unable to initialize storage. Please try refreshing the page.</p>
          <p style="font-size: 0.9rem; color: #888;">${error.message}</p>
        </div>
      `;
    });
  </script>
</body>
</html>
