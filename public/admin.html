<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Strikers Bowling - Admin Panel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .back-button {
      display: inline-block;
      padding: 10px 20px;
      background: transparent;
      border: 2px solid #4E98D5;
      color: #4E98D5;
      text-decoration: none;
      border-radius: 25px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background: #4E98D5;
      color: #ffffff;
    }

    h1 {
      color: #96333C;
      font-size: 3rem;
      text-align: center;
      margin-bottom: 20px;
    }

    .subtitle {
      text-align: center;
      color: #999;
      margin-bottom: 40px;
      font-size: 1.1rem;
    }

    .login-box {
      background: #2a2a2a;
      border-radius: 20px;
      padding: 40px;
      max-width: 400px;
      margin: 100px auto;
      border: 2px solid #96333C;
    }

    .login-box h2 {
      color: #96333C;
      margin-bottom: 30px;
      text-align: center;
    }

    input[type="password"],
    input[type="text"],
    textarea {
      width: 100%;
      padding: 15px;
      margin-bottom: 20px;
      background: #1a1a1a;
      border: 2px solid #444;
      border-radius: 10px;
      color: #ffffff;
      font-size: 1rem;
    }

    button {
      width: 100%;
      padding: 15px;
      background: #96333C;
      border: none;
      border-radius: 50px;
      color: #ffffff;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      background: #7a2830;
      transform: translateY(-2px);
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }

    .league-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .league-btn {
      padding: 10px 20px;
      background: transparent;
      border: 2px solid #444;
      color: #fff;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: auto;
    }

    .league-btn.active {
      background: #96333C;
      border-color: #96333C;
    }

    .instruction-box {
      background: #2a2a2a;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #444;
    }

    .instruction-box h3 {
      color: #4E98D5;
      margin-bottom: 10px;
    }

    .pdf-upload-box {
      background: #2a2a2a;
      border: 2px solid #4E98D5;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .pdf-upload-box h3 {
      color: #4E98D5;
      margin-bottom: 10px;
    }

    .upload-button {
      background: #4E98D5;
      width: auto;
      padding: 15px 30px;
      display: inline-block;
    }

    .upload-button:hover {
      background: #3a7bb5;
    }

    code {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 10px;
      display: block;
      font-family: monospace;
      margin: 10px 0;
      color: #4E98D5;
    }

    .status {
      text-align: center;
      margin: 15px 0;
      font-weight: 600;
      font-size: 1rem;
    }

    .status.success { color: #4CAF50; }
    .status.error { color: #f44336; }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .button-group button {
      flex: 1;
      min-width: 150px;
    }

    .secondary-btn {
      background: transparent;
      border: 2px solid #4E98D5;
      color: #4E98D5;
    }

    .secondary-btn:hover {
      background: #4E98D5;
      color: #ffffff;
    }

    textarea {
      min-height: 400px;
      font-family: monospace;
      resize: vertical;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="app"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    // Configure PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

    const ADMIN_PASSWORD = 'strikers2025';
    const LEAGUES = [
      'Monday Night Open',
      'Tuesday Night Ladies',
      'Wednesday Night Mixed',
      'Church League',
      'Youth'
    ];

    let isAuthenticated = sessionStorage.getItem('adminAuth') === 'true';
    let selectedLeague = 'Monday Night Open';
    let csvInput = '';

    function render() {
      const app = document.getElementById('app');
      
      if (!isAuthenticated) {
        app.innerHTML = `
          <div class="login-box">
            <h2>Admin Login</h2>
            <input type="password" id="password" placeholder="Enter password" />
            <button onclick="login()">Login</button>
          </div>
        `;
        document.getElementById('password').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') login();
        });
      } else {
        loadStandings();
        app.innerHTML = `
          <a href="/" class="back-button">‚Üê Back to Site</a>
          <h1>Update League Standings</h1>
          <p class="subtitle">Select a league and upload PDF or enter standings data below</p>
          
          <div class="league-selector">
            ${LEAGUES.map(league => `
              <button class="league-btn ${league === selectedLeague ? 'active' : ''}" 
                      onclick="selectLeague('${league}')">
                ${league}
              </button>
            `).join('')}
          </div>

          <div class="pdf-upload-box">
            <h3>üìÑ Upload PDF (LeagueSecretary)</h3>
            <p style="color: #999; margin-bottom: 15px;">
              Got a PDF from LeagueSecretary? Upload it here and we'll automatically extract the standings!
            </p>
            <input type="file" id="pdfFile" accept=".pdf" style="display: none;" onchange="handlePDFUpload(event)" />
            <button class="upload-button" onclick="document.getElementById('pdfFile').click()">
              üì§ Upload PDF
            </button>
            <div id="pdfStatus" class="status"></div>
          </div>

          <div class="instruction-box">
            <h3>üìã Or Enter Manually</h3>
            <p style="color: #999; margin-bottom: 10px;">Enter one team/player per line in this format:</p>
            <code>Rank, Team/Player Name, Wins, Losses, Points, Average</code>
            <p style="color: #999; font-size: 0.9rem; margin-top: 10px;"><strong>Example:</strong></p>
            <code>1, Strike Force, 12, 3, 36, 215<br>2, Pin Crushers, 10, 5, 30, 205</code>
          </div>

          <textarea id="csvInput" placeholder="Enter standings data here...">${csvInput}</textarea>

          <div class="button-group">
            <button onclick="saveStandings()">Save Standings</button>
            <button class="secondary-btn" onclick="clearStandings()">Clear Standings</button>
          </div>
        `;
      }
    }

    function login() {
      const password = document.getElementById('password').value;
      if (password === ADMIN_PASSWORD) {
        isAuthenticated = true;
        sessionStorage.setItem('adminAuth', 'true');
        render();
      } else {
        alert('Incorrect password!');
      }
    }

    function selectLeague(league) {
      selectedLeague = league;
      loadStandings();
      render();
    }

    function loadStandings() {
      const saved = localStorage.getItem(`standings_${selectedLeague}`);
      if (saved) {
        try {
          const data = JSON.parse(saved);
          csvInput = data.map(entry => 
            `${entry.rank}, ${entry.name}, ${entry.wins}, ${entry.losses}, ${entry.points}, ${entry.average}`
          ).join('\n');
        } catch (e) {
          csvInput = '';
        }
      } else {
        csvInput = '';
      }
    }

    function saveStandings() {
      const input = document.getElementById('csvInput').value.trim();
      if (!input) {
        alert('Please enter standings data!');
        return;
      }

      try {
        const lines = input.split('\n');
        const standings = lines.map(line => {
          const [rank, name, wins, losses, points, average] = line.split(',').map(s => s.trim());
          return { rank, name, wins, losses, points, average };
        });

        localStorage.setItem(`standings_${selectedLeague}`, JSON.stringify(standings));
        alert(`Standings for ${selectedLeague} saved successfully!`);
      } catch (e) {
        alert('Error saving standings. Please check your format.');
      }
    }

    function clearStandings() {
      if (confirm(`Are you sure you want to clear standings for ${selectedLeague}?`)) {
        localStorage.removeItem(`standings_${selectedLeague}`);
        csvInput = '';
        render();
        alert('Standings cleared!');
      }
    }

    async function handlePDFUpload(event) {
      const file = event.target.files[0];
      if (!file || file.type !== 'application/pdf') {
        alert('Please upload a valid PDF file');
        return;
      }

      const statusEl = document.getElementById('pdfStatus');
      statusEl.className = 'status';
      statusEl.textContent = 'Processing PDF...';

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }

        const standings = extractStandingsFromText(fullText);

        if (standings.length > 0) {
          csvInput = standings.map(entry => 
            `${entry.rank}, ${entry.name}, ${entry.wins}, ${entry.losses}, ${entry.points}, ${entry.average}`
          ).join('\n');
          
          document.getElementById('csvInput').value = csvInput;
          statusEl.className = 'status success';
          statusEl.textContent = `‚úÖ Successfully extracted ${standings.length} entries!`;
        } else {
          statusEl.className = 'status error';
          statusEl.textContent = '‚ö†Ô∏è Could not extract standings. Please enter manually.';
        }
      } catch (error) {
        console.error('PDF processing error:', error);
        statusEl.className = 'status error';
        statusEl.textContent = '‚ùå Error processing PDF. Please try manual entry.';
      }

      event.target.value = '';
    }

    function extractStandingsFromText(text) {
      const lines = text.split('\n').filter(line => line.trim());
      const standings = [];
      
      const standingsPattern = /^(\d+)[.\s]+(.+?)\s+(\d+)\s+(\d+)\s+(\d+)\s+([\d.]+)/;
      const altPattern = /^(\d+)\s+(.+?)\s+(\d+)\s+(\d+)\s+(\d+)\s+([\d.]+)/;
      
      for (const line of lines) {
        let match = line.match(standingsPattern) || line.match(altPattern);
        
        if (match) {
          const [, rank, name, wins, losses, points, average] = match;
          standings.push({ rank, name, wins, losses, points, average });
        }
      }

      if (standings.length === 0) {
        for (const line of lines) {
          const parts = line.trim().split(/\s{2,}|\t/);
          if (parts.length >= 6 && /^\d+$/.test(parts[0].trim())) {
            standings.push({
              rank: parts[0].trim(),
              name: parts[1].trim(),
              wins: parts[2].trim(),
              losses: parts[3].trim(),
              points: parts[4].trim(),
              average: parts[5].trim()
            });
          }
        }
      }

      return standings;
    }

    // Initial render
    render();
  </script>
</body>
</html>
