<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social Media Integration Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    
    h1 {
      color: #96333C;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .section {
      background: #243341;
      border: 2px solid #96333C;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .status.success {
      background: #4caf50;
      color: white;
    }
    
    .status.error {
      background: #f44336;
      color: white;
    }
    
    .status.warning {
      background: #ff9800;
      color: white;
    }
    
    .button {
      background: #96333C;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .button:hover {
      background: #b03d47;
    }
    
    .button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    
    .code-block {
      background: #1a1a2e;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 15px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .card {
      background: #1a1a2e;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }
    
    .card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    
    .card h3 {
      margin: 10px 0 5px 0;
      font-size: 16px;
      color: #96333C;
    }
    
    .card p {
      font-size: 12px;
      color: #aaa;
      margin: 5px 0;
    }
    
    #loading {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #96333C;
    }
    
    .spinner {
      border: 4px solid #444;
      border-top: 4px solid #96333C;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .info-card {
      background: #1a1a2e;
      border-left: 4px solid #96333C;
      padding: 15px;
      border-radius: 6px;
    }
    
    .info-card h4 {
      margin: 0 0 10px 0;
      color: #96333C;
      font-size: 14px;
    }
    
    .info-card .value {
      font-size: 24px;
      font-weight: bold;
      color: #4E98D5;
    }
  </style>
</head>
<body>
  <h1>üîç Social Media Integration Test Page</h1>
  
  <div class="section">
    <h2>üìã Configuration Status</h2>
    <div id="config-status">Checking configuration...</div>
  </div>
  
  <div class="section">
    <h2>üìä Cache Statistics</h2>
    <div id="cache-stats">Loading...</div>
  </div>
  
  <div class="section">
    <h2>üîß Actions</h2>
    <button class="button" onclick="testFetch()">üîÑ Fetch Posts</button>
    <button class="button" onclick="testFetchForce()">‚ö° Force Refresh</button>
    <button class="button" onclick="clearCache()">üóëÔ∏è Clear Cache</button>
    <button class="button" onclick="reloadStats()">üìä Reload Stats</button>
  </div>
  
  <div class="section">
    <h2>üì± Fetched Posts (<span id="post-count">0</span>)</h2>
    <div id="loading" style="display: none;">
      <div class="spinner"></div>
      Loading posts...
    </div>
    <div id="posts-container" class="grid"></div>
  </div>
  
  <div class="section">
    <h2>üêõ Debug Console</h2>
    <div id="console" class="code-block"></div>
  </div>

  <script type="module">
    import { createSocialMediaFeed } from './src/utils/socialMediaFeed.js';
    import socialMediaConfig, { validateConfig } from './src/utils/socialMediaConfig.js';

    let feedManager;
    const consoleLog = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = {
        'info': '‚ÑπÔ∏è',
        'success': '‚úÖ',
        'error': '‚ùå',
        'warning': '‚ö†Ô∏è'
      }[type] || '‚ÑπÔ∏è';
      
      const logMessage = `[${timestamp}] ${prefix} ${message}`;
      consoleLog.unshift(logMessage);
      
      // Keep only last 20 logs
      if (consoleLog.length > 20) consoleLog.pop();
      
      document.getElementById('console').innerHTML = consoleLog.join('\n');
      console.log(message);
    }

    async function checkConfig() {
      log('Checking configuration...');
      const validation = validateConfig();
      const statusDiv = document.getElementById('config-status');
      
      if (validation.valid) {
        const platforms = [];
        if (validation.platforms.instagram) platforms.push('Instagram');
        if (validation.platforms.facebook) platforms.push('Facebook');
        
        statusDiv.innerHTML = `
          <span class="status success">Enabled</span>
          <p>Configured platforms: ${platforms.join(', ')}</p>
          <div class="info-grid">
            ${validation.platforms.instagram ? `
              <div class="info-card">
                <h4>Instagram</h4>
                <p>Hashtag: #${socialMediaConfig.instagram.hashtag}</p>
                <p>User ID: ${socialMediaConfig.instagram.userId.substring(0, 10)}...</p>
              </div>
            ` : ''}
            ${validation.platforms.facebook ? `
              <div class="info-card">
                <h4>Facebook</h4>
                <p>Hashtag: #${socialMediaConfig.facebook.hashtag}</p>
                <p>Page ID: ${socialMediaConfig.facebook.pageId}</p>
              </div>
            ` : ''}
          </div>
        `;
        log(`Configuration valid - Platforms: ${platforms.join(', ')}`, 'success');
      } else {
        statusDiv.innerHTML = `
          <span class="status error">Disabled</span>
          <p>${validation.message}</p>
          <p>Check your .env.local file and ensure VITE_ENABLE_SOCIAL_MEDIA=true</p>
        `;
        log(validation.message, 'error');
      }
      
      return validation.valid;
    }

    async function loadCacheStats() {
      try {
        const stats = await feedManager.getCacheStats();
        const statsDiv = document.getElementById('cache-stats');
        
        if (stats.exists) {
          statsDiv.innerHTML = `
            <div class="info-grid">
              <div class="info-card">
                <h4>Status</h4>
                <div class="value" style="color: ${stats.expired ? '#f44336' : '#4caf50'}">
                  ${stats.expired ? 'Expired' : 'Active'}
                </div>
              </div>
              <div class="info-card">
                <h4>Posts Cached</h4>
                <div class="value">${stats.count}</div>
              </div>
              <div class="info-card">
                <h4>Cache Age</h4>
                <div class="value">${stats.ageMinutes} min</div>
              </div>
              <div class="info-card">
                <h4>Cached At</h4>
                <p style="font-size: 12px;">${stats.cachedAt.toLocaleString()}</p>
              </div>
            </div>
          `;
          log(`Cache stats: ${stats.count} posts, ${stats.ageMinutes} minutes old`, 'info');
        } else {
          statsDiv.innerHTML = '<p>No cached data</p>';
          log('Cache is empty', 'warning');
        }
      } catch (error) {
        log(`Error loading stats: ${error.message}`, 'error');
      }
    }

    async function displayPosts(posts) {
      const container = document.getElementById('posts-container');
      document.getElementById('post-count').textContent = posts.length;
      
      if (posts.length === 0) {
        container.innerHTML = '<p>No posts found</p>';
        return;
      }
      
      container.innerHTML = posts.map(post => `
        <div class="card">
          <img src="${post.imageUrl}" alt="${post.caption || 'Social media post'}" 
               onerror="this.src='https://via.placeholder.com/250x200?text=Image+Not+Available'">
          <h3>${post.category}</h3>
          <p><strong>${post.source}</strong></p>
          <p style="font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${(post.caption || 'No caption').substring(0, 50)}...
          </p>
          <p style="font-size: 10px; color: #666;">
            ${post.timestamp.toLocaleDateString()}
          </p>
          ${post.permalink ? `
            <a href="${post.permalink}" target="_blank" rel="noopener noreferrer" 
               style="color: #4E98D5; text-decoration: none; font-size: 12px;">
              View Original ‚Üí
            </a>
          ` : ''}
        </div>
      `).join('');
    }

    window.testFetch = async function() {
      const loading = document.getElementById('loading');
      const container = document.getElementById('posts-container');
      
      loading.style.display = 'block';
      container.innerHTML = '';
      log('Fetching posts...', 'info');
      
      try {
        const posts = await feedManager.fetchAllPosts(false);
        log(`Successfully fetched ${posts.length} posts`, 'success');
        displayPosts(posts);
        await loadCacheStats();
      } catch (error) {
        log(`Error fetching posts: ${error.message}`, 'error');
      } finally {
        loading.style.display = 'none';
      }
    };

    window.testFetchForce = async function() {
      const loading = document.getElementById('loading');
      const container = document.getElementById('posts-container');
      
      loading.style.display = 'block';
      container.innerHTML = '';
      log('Force fetching posts (bypassing cache)...', 'info');
      
      try {
        const posts = await feedManager.fetchAllPosts(true);
        log(`Successfully fetched ${posts.length} posts`, 'success');
        displayPosts(posts);
        await loadCacheStats();
      } catch (error) {
        log(`Error fetching posts: ${error.message}`, 'error');
      } finally {
        loading.style.display = 'none';
      }
    };

    window.clearCache = async function() {
      log('Clearing cache...', 'info');
      try {
        await feedManager.clearCache();
        log('Cache cleared successfully', 'success');
        document.getElementById('posts-container').innerHTML = '';
        document.getElementById('post-count').textContent = '0';
        await loadCacheStats();
      } catch (error) {
        log(`Error clearing cache: ${error.message}`, 'error');
      }
    };

    window.reloadStats = async function() {
      log('Reloading statistics...', 'info');
      await loadCacheStats();
    };

    // Initialize
    (async function init() {
      log('Initializing test page...', 'info');
      
      const configValid = await checkConfig();
      
      if (configValid) {
        feedManager = createSocialMediaFeed(socialMediaConfig);
        await loadCacheStats();
        log('Test page ready! Click "Fetch Posts" to load social media content.', 'success');
      } else {
        log('Configuration invalid. Please set up .env.local file.', 'error');
      }
    })();
  </script>
</body>
</html>
